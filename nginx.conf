events {}

http {
  # 文字コードやMIMEはデフォルトでOKだが、明示しても良い
  # include       /etc/nginx/mime.types;
  # default_type  application/octet-stream;
  sendfile on;

  server {
    listen 80;

    # --- 圧縮（API/静的に効く） ---
    gzip on;
    gzip_types application/json application/javascript text/css text/plain image/svg+xml;
    gzip_min_length 512;
    gzip_vary on;
    gzip_proxied any;

    # --- セキュリティ系ヘッダ（軽め） ---
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-XSS-Protection "1; mode=block" always;

    # --- API: /api/ → http://api:3000 ---
location /api/ {
  # /api/ を外す
  rewrite ^/api/?(.*)$ /$1 break;

  proxy_pass http://api:3000;  # ← 末尾にスラッシュは付けない（上で剥がすから）
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Connection        "";
  proxy_read_timeout 60s;
  proxy_send_timeout 60s;
}

    # --- 静的ファイル（任意） ---
    location / {
      root /usr/share/nginx/html;
      try_files $uri /index.html;  # SPAならこれでOK
      # 静的キャッシュ（任意・お好みで）
      # add_header Cache-Control "public, max-age=31536000, immutable";
    }
  }
}
